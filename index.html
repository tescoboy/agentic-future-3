<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signals Agent - AI-Powered Audience Targeting</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Utility tweaks */
        .card { padding: 1rem; }
        .section { margin-bottom: 1.5rem; }
        .controls { gap: 0.5rem; }
        
        /* Truncation helpers */
        .text-ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .text-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .text-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .word-break {
            word-break: break-word;
        }
        
        /* Table styling */
        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.075);
        }
        
        .table th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
        
        /* Badge styling */
        .badge-signal-type {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Count chip */
        .count-chip {
            font-size: 0.7rem;
            padding: 0.1rem 0.3rem;
            background-color: #6c757d;
            color: white;
            border-radius: 10px;
            margin-left: 0.25rem;
        }
        
        /* Toast positioning */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1050;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Signals Demo</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Signals</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="card-title mb-0">
                            <i class="bi bi-search me-2"></i>
                            Signals Search
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label for="signalSpec" class="form-label">Signal Specification</label>
                                <input type="text" class="form-control" id="signalSpec" placeholder="Describe the signals you want">
                            </div>
                            <div class="col-md-4">
                                <label for="maxResults" class="form-label">Max Results</label>
                                <input type="number" class="form-control" id="maxResults" value="10" min="1" max="100">
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label for="baseUrl" class="form-label">API Base URL (optional)</label>
                            <input type="url" class="form-control" id="baseUrl" placeholder="https://your-render-service.onrender.com">
                            <div class="form-text">If you host the API on Render and the UI on Vercel, ensure CORS is enabled on the API.</div>
                        </div>
                        
                        <div class="mt-3">
                            <label for="principalId" class="form-label">Principal ID (optional)</label>
                            <input type="text" class="form-control" id="principalId" placeholder="acme_corp, luxury_brands_inc, etc.">

                            <div class="form-text">Enter a principal ID to access personalized and private segments. Leave empty for public segments only.</div>

                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" onclick="fetchSignals()">
                                <i class="bi bi-search me-2"></i>
                                Fetch Signals
                            </button>
                        </div>
                        
                        <div id="resultContainer">
                            <div class="empty-state">
                                <i class="bi bi-search"></i>
                                <h5>No signals fetched yet</h5>
                                <p class="mb-0">Enter a signal specification and click "Fetch Signals" to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay" aria-live="polite">
        <div class="loading-content">
            <div class="gradient-blob"></div>
            <div class="fetching-text">
                Fetching signals<span class="fetching-dots"></span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentController = null;

        async function fetchSignals() {
            const signalSpec = document.getElementById('signalSpec').value.trim();
            const maxResults = document.getElementById('maxResults').value;
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const principalId = document.getElementById('principalId')?.value.trim() || '';
            const resultContainer = document.getElementById('resultContainer');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            if (!signalSpec) {
                alert('Please enter a signal specification');
                return;
            }
            
            const base = baseUrl || window.location.origin;
            let url = `${base}/api/signals?spec=${encodeURIComponent(signalSpec)}&max_results=${maxResults}`;
            
            // Add principal_id parameter if provided
            if (principalId) {
                url += `&principal_id=${encodeURIComponent(principalId)}`;
            }
            
            if (currentController) {
                currentController.abort();
            }
            
            currentController = new AbortController();
            const timeoutId = setTimeout(() => currentController.abort(), 20000);
            
            loadingOverlay.style.display = 'flex';
            loadingOverlay.setAttribute('aria-busy', 'true');
            resultContainer.innerHTML = '';
            
            try {
                const response = await fetch(url, {
                    signal: currentController.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    resultContainer.innerHTML = `
                        <div class="result-area">
                            <strong>Response (${response.status}):</strong>
                            ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                } else {
                    let errorHint = '';
                    if (response.status === 401 || response.status === 403 || response.status === 404) {
                        errorHint = '<br><br><strong>Hint:</strong> This might be a CORS issue. Ensure your API has CORS enabled for your frontend domain.';
                    }
                    
                    resultContainer.innerHTML = `
                        <div class="error-message">
                            <strong>Error ${response.status}:</strong> ${response.statusText}
                            <br><br>
                            <strong>URL:</strong> ${url}
                            ${errorHint}
                        </div>
                    `;
                }
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    resultContainer.innerHTML = `
                        <div class="error-message">
                            <strong>Request Timeout:</strong> The request took longer than 20 seconds and was cancelled.
                            <br><br>
                            <strong>URL:</strong> ${url}
                        </div>
                    `;
                } else {
                    resultContainer.innerHTML = `
                        <div class="error-message">
                            <strong>Network Error:</strong> ${error.message}
                            <br><br>
                            <strong>URL:</strong> ${url}
                            <br><br>
                            <strong>Hint:</strong> Check if the API is running and accessible from this domain.
                        </div>
                    `;
                }
            } finally {
                loadingOverlay.style.display = 'none';
                loadingOverlay.setAttribute('aria-busy', 'false');
                currentController = null;
            }
        }
    </script>
</body>
</html>
